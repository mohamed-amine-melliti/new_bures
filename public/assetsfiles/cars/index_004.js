/*! datapump 4.12.0 */
import{initializeLogger as e}from"@seamless/logger";import{subscribe as t,getDispatchers as i}from"@seamless/one-context";import{AUTHENTICATION_CONNECTION as n,isLoggedIn as o,getJwe as r}from"@b2x/authentication-library";function c(e,t,i,n){return new(i||(i=Promise))((function(o,r){function c(e){try{a(n.next(e))}catch(e){r(e)}}function s(e){try{a(n.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(c,s)}a((n=n.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const s="@dh-io/datapump";var a,d,u,l,v,f;!function(e){e.LOCAL="LOCAL",e.TEST="TEST",e.DEV="DEV",e.INT="INT",e.PPROD="PPROD",e.PROD="PROD"}(a||(a={})),function(e){e.AFFINITY_SCORE="AFFINITY_SCORE",e.LIVE_MARKETS="LIVE_MARKETS",e.FEEDBACK="PREFERENCE_SERVICE"}(d||(d={})),function(e){e.MMVVS="MMV-VS",e.TOUCHPOINTS="MM-CONSID_TOUCHPOINTS",e.TSS_WISHLIST="TSS_WISHLIST-SAVED-PRODUCTS",e.MM_CONSID_VEHICLES="MM-CONSID_VEHICLES",e.B2XCORE_AUTHENTICATION="B2XCORE_AUTHENTICATION",e.B2XCORE_LOGIN="B2XCORE_USER_LOGIN",e.LIVE_MARKETS="LIVE_MARKETS"}(u||(u={}));class PageConnectionFetcher{static initialize(){this.isInitialized||(this.isInitialized=!0,this.subscribeToPageConnection())}static subscribeToPageConnection(){try{t("PageConnection",{tenant:this.tenant,componentName:this.componentName,callback:e=>{this.pageEnvData=e,this.logger.log("Page environment data updated",{state:e})}})}catch(e){this.logger.error("Error subscribing to PageConnection",{error:e})}}static isCookieConsentGranted(e){return c(this,void 0,void 0,(function*(){var t,i;return this.logger.log("Entering isCookieConsentGranted"),this.isInitialized||this.initialize(),yield this.subscribeToConsentConnection(),null!==(i=null===(t=this.consentData)||void 0===t?void 0:t.some((t=>t.name===e&&t.enabled)))&&void 0!==i&&i}))}static getMpc(){return c(this,void 0,void 0,(function*(){var e,t,i;return this.isInitialized||this.initialize(),null!==(i=null===(t=null===(e=this.pageEnvData)||void 0===e?void 0:e.pageEnvironmentVariables)||void 0===t?void 0:t.country)&&void 0!==i?i:""}))}static getLanguage(){return c(this,void 0,void 0,(function*(){var e,t,i;return this.isInitialized||this.initialize(),null!==(i=null===(t=null===(e=this.pageEnvData)||void 0===e?void 0:e.pageEnvironmentVariables)||void 0===t?void 0:t.language)&&void 0!==i?i:""}))}static isNonProd(){return c(this,void 0,void 0,(function*(){this.isInitialized||this.initialize();return(yield this.getStage())!==a.PROD}))}static getStage(){return c(this,void 0,void 0,(function*(){var e,t,i;return this.isInitialized||this.initialize(),null!==(i=null===(t=null===(e=this.pageEnvData)||void 0===e?void 0:e.pageEnvironmentVariables)||void 0===t?void 0:t.stage)&&void 0!==i?i:""}))}static subscribeToConsentConnection(){return this.logger.log("Entering subscribeToConsentConnection"),new Promise(((e,i)=>{const n=setTimeout((()=>{this.logger.log("Timeout: No consent data received within 10 seconds"),e()}),1e4);try{t("ConsentContextConnection",{tenant:this.tenant,componentName:this.componentName,callback:t=>{this.logger.log("Received consent data update",{state:t}),t&&t.length>0&&(clearTimeout(n),this.consentData=t,this.logger.log("Consent data updated",{state:t}),e())}})}catch(e){clearTimeout(n),this.logger.error("Error subscribing to ConsentContextConnection",{error:e}),i(e)}}))}}PageConnectionFetcher.logger=e(s),PageConnectionFetcher.tenant="cuan",PageConnectionFetcher.componentName="datapump",PageConnectionFetcher.isInitialized=!1;class DataLayerFetcher{static getDataLayerByEvent(e){const t=this.dataLayer?this.dataLayer.filter((t=>t.event===e)):[],i=t[(null==t?void 0:t.length)-1];return i||{}}static setAffinity(e){const t=this.getDataLayerByEvent("pageview");this.dataLayer&&(t.page.affinity=e,this.dataLayer.push(this.getDataLayerByEvent("pageview")))}}DataLayerFetcher.dataLayer=window.dataLayer_ow,DataLayerFetcher.logger=e(s);class B2xFetcher{static onAuthenticationEvent(){return c(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{var i;setTimeout(t,3e3),null===(i=this.store)||void 0===i||i.subscribe(n,(i=>{var n,r;if(i)this.isLoggedIn=o(i),e();else{const i=null===(r=null===(n=DataLayerFetcher.getDataLayerByEvent("global"))||void 0===n?void 0:n.user)||void 0===r?void 0:r.loginState;this.isLoggedIn=i&&!i.includes("out"),this.isLoggedIn?e():t(new Error("Authentication failed"))}}))}))}))}static isUserLoggedIn(){return c(this,void 0,void 0,(function*(){return this.logger.log("Checking LoggedIn Status"),yield this.onAuthenticationEvent(),this.logger.log("Logged in status is: ",this.isLoggedIn),this.isLoggedIn}))}static onJweEvent(){return c(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{var i;null===(i=this.store)||void 0===i||i.subscribe(n,(i=>{i?(this.jweValue=r(i)||"",e()):t(new Error("JWE token failed"))}))}))}))}static getJwe(){return c(this,void 0,void 0,(function*(){yield this.onJweEvent();switch(yield PageConnectionFetcher.getStage()){case a.LOCAL:case a.TEST:case a.DEV:return this.logger.log("Using Test JWE"),this.TESTJWE}return`Bearer ${this.jweValue}`}))}}B2xFetcher.TESTJWE="00110207a62c4365",B2xFetcher.store=window.top.seamlessStore.initializeStore(),B2xFetcher.logger=e(s),function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.DELETE="DELETE"}(l||(l={}));class APIService{static request(e,t,i,n){return c(this,void 0,void 0,(function*(){const o=yield PageConnectionFetcher.getStage(),r=this.buildFullUrl(e,o),s=yield this.getHeaders(o,n),a=i?JSON.stringify(i):void 0,d={headers:s,method:t,body:a};return fetch(r.toString(),d).then((e=>c(this,void 0,void 0,(function*(){try{if(200===e.status){return yield e.json()}return this.logger.log(e.status),{}}catch(e){return this.logger.error(e),{}}}))))}))}static buildFullUrl(e,t){const i=this.getApiBaseUrl(t);return new URL(`${i}${e}`)}static getHeaders(e,t){return c(this,void 0,void 0,(function*(){let e=t;return e=t&&0!==t.length?t:yield B2xFetcher.getJwe(),Promise.resolve({Authorization:e,"Content-Type":"application/json"})}))}static getApiBaseUrl(e){const t="/api/v1";switch(e){case a.LOCAL:case a.DEV:return"https://dev.eu.api.oneweb.mercedes-benz.com/mbscore"+t;case a.TEST:return"https://test.eu.api.oneweb.mercedes-benz.com/mbscore"+t;case a.INT:case a.PPROD:return"https://int.eu.api.oneweb.mercedes-benz.com/mbscore"+t;case a.PROD:return"https://eu.api.oneweb.mercedes-benz.com/mbscore"+t;default:throw new Error("Failed to get the stage environment.")}}}APIService.logger=e(s),function(e){e.POST_AFFINITY="/affinity/score",e.POST_ONEDOC="/consent/onedoc",e.GET_LIVE_AFFINITY="/status/markets",e.POST_FEEDBACK="/feedback"}(v||(v={})),function(e){e.SET_AFFINITY_SCORE="AFFINITY_SCORE/SET_AFFINITY_SCORE",e.LOAD_PERSISTED_STATE="AFFINITY_SCORE/LOAD_PERSISTED_STATE"}(f||(f={}));const h=e=>({type:f.LOAD_PERSISTED_STATE,state:e}),y=e=>({type:f.SET_AFFINITY_SCORE,state:e}),g=e=>t=>c(void 0,void 0,void 0,(function*(){t(y({affinityScore:e}))}));class AffinityScoreConnection extends window.top.seamlessStore.PersistentConnection{constructor(){super(d.AFFINITY_SCORE)}get initialState(){return E}get storageType(){return"session"}getReducer(){return p}getPublicDispatchers(){return{setAffinityScore:y,saveAffinityScoreToStore:g,loadPersistedState:h}}loadPersistedStateCallback(e){return c(this,void 0,void 0,(function*(){return h(e)}))}transformToPersistentState(e){return Object.assign(Object.assign({},e),{fromPersistFunction:!0})}}const E={affinityScore:void 0},p=(e,t)=>{switch(t.type){case f.LOAD_PERSISTED_STATE:return t.state?((e,t)=>void 0===t?e:t)(e,t.state):e;case f.SET_AFFINITY_SCORE:return Object.assign(Object.assign({},e),t.state);default:return e}};let b;const C=new Uint8Array(16);function S(){if(!b&&(b="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!b))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return b(C)}const m=[];for(let e=0;e<256;++e)m.push((e+256).toString(16).slice(1));var k,F={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function w(e,t,i){if(F.randomUUID&&!e)return F.randomUUID();const n=(e=e||{}).random||(e.rng||S)();return n[6]=15&n[6]|64,n[8]=63&n[8]|128,function(e,t=0){return m[e[t+0]]+m[e[t+1]]+m[e[t+2]]+m[e[t+3]]+"-"+m[e[t+4]]+m[e[t+5]]+"-"+m[e[t+6]]+m[e[t+7]]+"-"+m[e[t+8]]+m[e[t+9]]+"-"+m[e[t+10]]+m[e[t+11]]+m[e[t+12]]+m[e[t+13]]+m[e[t+14]]+m[e[t+15]]}(n)}(k||(k={})).SET_LIVE_MARKETS="LIVE_MARKETS/SET_LIVE_MARKETS";const P=e=>({type:k.SET_LIVE_MARKETS,state:e});class MarketConnection extends window.top.seamlessStore.SeamlessConnection{constructor(){super(d.LIVE_MARKETS)}get initialState(){return A}getReducer(){return M}getPublicDispatchers(){return{setMarket:P}}}const A={liveMarkets:void 0},M=(e=A,t)=>t.type===k.SET_LIVE_MARKETS?Object.assign(Object.assign({},e),t.state):e;class MarketFetcher{static fetchLiveMarkets(){return c(this,void 0,void 0,(function*(){return new Promise((e=>{this.store.subscribe(this.connectionName,(t=>{this.liveMarkets=t,e()}))}))}))}static getLiveMarkets(){return c(this,void 0,void 0,(function*(){var e,t;if(yield this.fetchLiveMarkets(),this.liveMarkets&&(null===(e=this.liveMarkets)||void 0===e?void 0:e.liveMarkets))return null===(t=this.liveMarkets)||void 0===t?void 0:t.liveMarkets;Promise.resolve(null)}))}}var T,_;MarketFetcher.store=window.top.seamlessStore.initializeStore(),MarketFetcher.logger=e(s),MarketFetcher.connectionName=d.LIVE_MARKETS,MarketFetcher.liveMarkets={liveMarkets:{}};class AffinityManager{static setAffinityScoreDispatcher(){return c(this,void 0,void 0,(function*(){var e;yield c(void 0,void 0,void 0,(function*(){e||(e=window.top.seamlessStore.initializeStore()),e.addConnection(new AffinityScoreConnection)})),T.affinityScoreDispatcher=yield T.store.getConnectionDispatchers(d.AFFINITY_SCORE)}))}static setMarketDispatcher(){return c(this,void 0,void 0,(function*(){var e;yield c(void 0,void 0,void 0,(function*(){e||(e=window.top.seamlessStore.initializeStore()),e.addConnection(new MarketConnection)})),T.marketDispatcher=yield T.store.getConnectionDispatchers(d.LIVE_MARKETS)}))}static setAffinityScoreOnOneContext(e){return c(this,void 0,void 0,(function*(){(yield i("cuan","MBScoreConnection")).updateAffinityScore(e)}))}static getCookieValue(){try{const e=this.getCookieValueFromDocument();if(e)return e;const t=this.createCookie();return t||void 0}catch(e){return void T.logger.log("Error while getting cookie value:",e)}}static getCookieValueFromDocument(){return T.cookieMatch||(T.cookieMatch=`; ${document.cookie}`.match(`;\\s*${T.cookieName}=([^;]+)`)),T.cookieMatch?T.cookieMatch[1]:void 0}static createCookie(){try{const e=new Date;e.setFullYear(e.getFullYear()+1);const t=e.toUTCString(),i=w();return T.setValueByPath(document,this.cookieName,i,{path:"/",domain:window.location.hostname,expires:t}),i}catch(e){return void this.logger.error(e)}}static setValueByPath(e,t,i,n){const o=t.split(".");let r=e;for(let e=0;e<o.length-1;e++){const t=o[e];"__proto__"!==t&&"constructor"!==t&&"prototype"!==t&&("object"!=typeof r[t]&&(r[t]={}),r=r[t])}document.cookie=`${o.join(".")}=${i}; path=${n.path||"/"}; domain=${n.domain||window.location.hostname}; expires=${n.expires||""}`}static isCookieEnabled(e){return c(this,void 0,void 0,(function*(){this.logger.log("Entering isCookieEnabled");return yield PageConnectionFetcher.isCookieConsentGranted(e)}))}static hasBm(e){return e.baumuster&&null!==e.baumuster.length}static isDuplicatePageViewEvent(e){return JSON.stringify(T.scoredPageviewRequest)===JSON.stringify(e)}static getLiveAffinityMarkets(){return c(this,void 0,void 0,(function*(){this.logger.log("Entering getLiveAffinityMarkets");return(yield APIService.request(v.GET_LIVE_AFFINITY,l.GET))||{}}))}static handleAffinityPayload(e){const t={pageName:"",pageType:"",baumuster:"",market:"",language:"",visited_url:""};if("event"in e&&"page"in e){const i=e;if("products"in i.page){const e=i,n=e.page.products;if(1===n.length){const e=n[0];t.baumuster=e.variantId}t.pageName=e.page.name,t.pageType=e.page.type}else if("cart"in i.page&&1===i.page.cart.products.length){const e=i,n=e.page.cart.products[0];t.pageName=e.page.name,t.pageType=e.page.type,t.baumuster=n.variantId}else{const e=i;if(t.pageName=e.page.name,t.pageType=e.page.type,"vehicle"in i.page){const e=i.page.vehicle;t.baumuster=(null==e?void 0:e.baumusterId)||(null==e?void 0:e.modelCode)||""}}}return t}}T=AffinityManager,AffinityManager.logger=e(s),AffinityManager.store=window.top.seamlessStore.initializeStore(),AffinityManager.cookieName="mb_score",AffinityManager.sessionName=["Mercedes-Benz_Product_Affinity_Score","Mercedes-Benz_Data-Sharing"],AffinityManager.liveMarketsInStorage=sessionStorage.getItem("liveMarkets"),AffinityManager.cookieMatch=null,AffinityManager.calcAffinityScore=(e,t)=>c(void 0,void 0,void 0,(function*(){var e,i,n,o,r,c,s;yield T.setMarketDispatcher(),T.logger.log("Entering calcAffinityScore");try{T.logger.log("Getting cookies status 1");const a=yield T.isCookieEnabled(T.sessionName[0]);T.logger.log("Getting cookies status 2");const d=yield T.isCookieEnabled(T.sessionName[1]);T.logger.log("Making Promises");const[u,f,h,y]=yield Promise.allSettled([PageConnectionFetcher.getMpc(),PageConnectionFetcher.getLanguage(),B2xFetcher.isUserLoggedIn(),MarketFetcher.getLiveMarkets()]);if("fulfilled"===u.status&&"fulfilled"===f.status&&"fulfilled"===h.status&&"fulfilled"===y.status){if(T.logger.log("Promises fulfilled"),T.logger.log("Cookie First = "+a+" Cookie Second = "+d),a&&d&&!h.value){const a=t||(y.value&&(null===(i=null===(e=y.value)||void 0===e?void 0:e.affinityScore)||void 0===i?void 0:i.length)>0?y.value:yield T.getLiveAffinityMarkets()),d=null===(n=null==a?void 0:a.affinityScore)||void 0===n?void 0:n.find((e=>e===u.value));if(T.logger.log("Live Markets = "+d+"Markets = "+y.value),d){const e=DataLayerFetcher.getDataLayerByEvent("pageview");T.logger.log("Fetched pageview event: ",e);const i=T.handleAffinityPayload(e);if(i.market=u.value,i.language=f.value,i.visited_url=window.location.href,T.logger.log("Current Payload: ",i),!T.isDuplicatePageViewEvent(i)||V()){T.scoredPageviewRequest=i;let e="";e="Bearer "+T.getCookieValue(),T.logger.log("calling POST_AFFINITY");const n=yield APIService.request(v.POST_AFFINITY,l.POST,i,e);y.value&&(null===(r=null===(o=y.value)||void 0===o?void 0:o.affinityScore)||void 0===r?void 0:r.length)>0||(T.marketDispatcher||(yield T.setMarketDispatcher()),null===(c=T.marketDispatcher)||void 0===c||c.setMarket({liveMarkets:null!=a?a:t})),T.affinityScoreDispatcher||(yield T.setAffinityScoreDispatcher()),null===(s=T.affinityScoreDispatcher)||void 0===s||s.saveAffinityScoreToStore(n),T.setAffinityScoreOnOneContext(n)}}}}else T.logger.log("one or more promise were rejected")}catch(e){T.logger.log("An Error Occured:",e)}})),function(e){e.LOAD_PERSISTED_STATE="PREFERENCE_SERVICE/LOAD_PERSISTED_STATE",e.APPEND_FEEDBACK="PREFERENCE_SERVICE/APPEND_FEEDBACK",e.CLEAR_FEEDBACKS="PREFERENCE_SERVICE/CLEAR_FEEDBACKS"}(_||(_={}));const O=e=>({type:_.LOAD_PERSISTED_STATE,state:e}),I=()=>({type:_.CLEAR_FEEDBACKS}),D=e=>({type:_.APPEND_FEEDBACK,feedback:e}),R=e=>t=>c(void 0,void 0,void 0,(function*(){t(D(Object.assign({},e)))})),L={feedback:[]};class FeedbackConnection extends window.top.seamlessStore.PersistentConnection{constructor(){super(d.FEEDBACK)}get initialState(){return L}get storageType(){return"session"}getReducer(){return N}getPublicDispatchers(){return{appendFeedback:D,saveFeedbackToStore:R,loadPersistedFeedbackState:O,clearFeedbacks:I}}loadPersistedStateCallback(e){return c(this,void 0,void 0,(function*(){return O(e)}))}transformToPersistentState(e){return{feedback:e.feedback,fromPersistFunction:!0}}}const N=(e=L,t)=>{switch(t.type){case _.LOAD_PERSISTED_STATE:return t.state?Object.assign(Object.assign({},e),t.state):e;case _.APPEND_FEEDBACK:return Object.assign(Object.assign({},e),{feedback:[...e.feedback||[],t.feedback]});case _.CLEAR_FEEDBACKS:return Object.assign(Object.assign({},e),{feedback:[]});default:return e}};var B;class FeedbackManager{static setFeedbackDispatcher(){return c(this,void 0,void 0,(function*(){var e;yield c(void 0,void 0,void 0,(function*(){e||(e=window.top.seamlessStore.initializeStore()),e.addConnection(new FeedbackConnection)})),B.feedbackDispatcher=yield B.store.getConnectionDispatchers(d.FEEDBACK)}))}}B=FeedbackManager,FeedbackManager.logger=e(s),FeedbackManager.store=window.top.seamlessStore.initializeStore(),FeedbackManager.checkForFeedbacks=()=>c(void 0,void 0,void 0,(function*(){B.store.subscribe(d.FEEDBACK,(e=>{B.feedbackState=e})),yield new Promise((e=>setTimeout(e,0))),B.feedbackState.feedback&&0!==B.feedbackState.feedback.length?(B.logger.log("Not Empty"),yield B.postFeedbacks(B.feedbackState.feedback)):B.logger.log("Empty")})),FeedbackManager.postFeedbacks=e=>c(void 0,void 0,void 0,(function*(){var t;B.logger.log("Entering postFeedback");try{B.logger.log("Current Payload: ",e);const i=e.map((e=>Object.assign({},e)));B.logger.log("calling POST_FEEDBACK for:",i),yield APIService.request(v.POST_FEEDBACK,l.POST,i),B.feedbackDispatcher||(yield B.setFeedbackDispatcher()),B.logger.log("All feedbacks posted successfully. Clearing feedback state."),null===(t=B.feedbackDispatcher)||void 0===t||t.clearFeedbacks()}catch(e){B.logger.log("An Error Occurred:",e)}}));const V=()=>!!document.querySelector("owc-stage"),j=e(s),x=e(s);function U(e){return c(this,void 0,void 0,(function*(){yield(e=>c(void 0,void 0,void 0,(function*(){(yield B2xFetcher.isUserLoggedIn())||(yield AffinityManager.calcAffinityScore(e))})))(e)}))}function z(){return c(this,void 0,void 0,(function*(){yield c(void 0,void 0,void 0,(function*(){yield FeedbackManager.checkForFeedbacks()}))}))}function $(){return c(this,void 0,void 0,(function*(){yield c(void 0,void 0,void 0,(function*(){j.log("starting cookie test"),j.log("isCookieEnabled Mercedes-Benz_Product_Affinity_Score returns: ",yield AffinityManager.isCookieEnabled("Mercedes-Benz_Product_Affinity_Score")),j.log("isCookieEnabled Mercedes-Benz_Data-Sharing returns: ",yield AffinityManager.isCookieEnabled("Mercedes-Benz_Data-Sharing")),j.log("getCookieValueFromDocument returned: ",AffinityManager.getCookieValueFromDocument()),j.log("createCookie returned: ",AffinityManager.createCookie())}))}))}AffinityManager.setAffinityScoreDispatcher(),FeedbackManager.setFeedbackDispatcher();let J="";new MutationObserver((function(e){location.href!==J&&(J=location.href,x.log(`URL change to ${location.href}`),U(),z())})).observe(document,{subtree:!0,childList:!0}),window.datapump={calculateAffinityScore:U,checkCookie:$,checkFeedbacks:z};export{U as calculateAffinityScore,$ as checkCookie,z as checkFeedbacks};
//# sourceMappingURL=index.js.map
