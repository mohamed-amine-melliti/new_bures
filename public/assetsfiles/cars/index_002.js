/*! onecontext 1.9.0 */
import{subscribe as t,setupContext as e}from"@seamless/one-context";import{SeamlessConnection as n,PersistentConnection as s}from"@seamless/store";import{useSSRContext as o}from"vue";var i;!function(t){t.store="store",t.static="static"}(i||(i={})),i.static,i.store;const r="seamless";class OneContextStore extends n{type=i.store}class OneContextPersistentStore extends s{type=i.store}class OneContextStatic{type=i.static}const a=()=>"undefined"!=typeof window;class PageEnvironmentConnection extends OneContextStatic{get initialState(){if(!a()){const t=o();return{pageEnvironmentVariables:t?.AEMContext.pageAEMContext,environmentVariables:t?.AEMContext.globalAEMContext}}const t=window.top||window;return{pageEnvironmentVariables:t?.aemNamespace?.pageEnvironmentVariables??{},environmentVariables:t?.aemNamespace?.environmentVariables??{}}}getContext=async()=>this.initialState}const c="UPDATE_AFFINITY_SCORE",l={};class MBScoreConnection extends OneContextPersistentStore{allowedTenants=["cuan"];constructor(){super("MBSCORE_CONNECTION")}get initialState(){return l}get storageType(){return"local"}loadPersistedStateCallback(t){return this.getAction("MBSCORE_LOAD_PERSISTED_STATE",t)}async transformToPersistentState(t){return t}getReducer(){return(t=l,e)=>e.type===this.getActionType(c)?{...t,...e.payload}:t}getPublicDispatchers(){return{updateAffinityScore:t=>this.getAction(c,t)}}}const u="UPDATE_DEALER_CONTEXT";class DealerContextConnection extends OneContextPersistentStore{allowedTenants=["seamless"];constructor(){super("DEALER_CONTEXT_CONNECTION")}async onBeforeRegister(t){const e=await this.loadPersistedStateCallback(this.initialState);null!=e&&t(e),await this.storeState(this.initialState)}get initialState(){if(!a()){const t=o();return t?.AEMContext.dealerContext}const t=window.top||window;if(t.aemNamespace?.dealerContext)return{allOutletId:t.aemNamespace.dealerContext.allOutletId,outletId:t.aemNamespace.dealerContext.outletId};const e=new URLSearchParams(window.location.search);if((n=e).has("allOutletId")||n.has("outletId")||n.has("gsOutletId")||n.has("allGsOutletIds"))return(t=>{const e={};return t.has("allGsOutletIds")&&(e.allOutletId=t.get("allGsOutletIds")),t.has("allOutletId")&&(e.allOutletId=t.get("allOutletId")),t.has("gsOutletId")&&(e.outletId=t.get("gsOutletId")),t.has("outletId")&&(e.outletId=t.get("outletId")),e})(e);var n;const s=`swsp:${this.name}`;if(sessionStorage.getItem(s)){return JSON.parse(sessionStorage.getItem(s))}return{}}get storageType(){return"session"}loadPersistedStateCallback(t){return this.getAction("DEALER_CONTEXT_LOAD_PERSISTED_STATE",t)}async transformToPersistentState(t){return t}getReducer(){return(t=this.initialState,e)=>e.type===this.getActionType(u)?{...t,...e.payload}:t}getPublicDispatchers(){return{updateDealerContext:t=>this.getAction(u,t)}}}const d="UPDATE_BRAND_CONTEXT",C={};class BrandContextConnection extends OneContextStore{allowedTenants=[];subBrands=["AMG","MAYBACH"];constructor(){super("BRAND_CONTEXT_CONNECTION")}formatSubBrand(t){let e=null;return this.subBrands.forEach((n=>{t.toUpperCase().endsWith(n)&&(e=n)})),e}getSubBrand(t){return t?.brand?.subBrand?this.formatSubBrand(t.brand.subBrand):1===t?.vehicleData?.subBrands?.length?this.formatSubBrand(t.vehicleData.subBrands[0]):null}get initialState(){if(!a()){const t=o();return{businessUnit:t?.AEMContext.pageAEMContext.businessUnit,subBrand:this.getSubBrand(t?.AEMContext.pageAEMContext)}}const t=window.top||window;return{businessUnit:t?.aemNamespace?.pageEnvironmentVariables.businessUnit,subBrand:this.getSubBrand(t?.aemNamespace?.pageEnvironmentVariables)}}getReducer(){return(t=C,e)=>e.type===this.getActionType(d)?{...t,...e.payload}:t}getPublicDispatchers(){return{updateBrandContext:t=>this.getAction(d,t)}}}const S="UPDATE_USER_VEHICLE",h={selectedVehicleVin:""};class UserVehicleConnection extends OneContextPersistentStore{allowedTenants=["mmv","oab","atcscos","seamless"];profileId;constructor(){super("USER_VEHICLE_CONNECTION"),this.profileConnectionSubscribe()}profileConnectionSubscribe=()=>{import("@seamless/one-context").then((async t=>{t.subscribe("ProfileConnection",{tenant:"seamless",componentName:"OneContext-UserVehicleConnection",callback:e=>{void 0!==this.profileId&&this.profileId!==e.activeProfile.id&&t.getDispatchers("seamless","UserVehicleConnection").then((t=>{t.updateUserVehicle({selectedVehicleVin:""})})),this.profileId=e.activeProfile.id}})}))};async onBeforeRegister(t){const e=await this.loadPersistedStateCallback(this.initialState);null!=e&&t(e),await this.storeState(this.initialState)}get initialState(){const t=`swsp:${this.name}`,e=!!a()&&sessionStorage.getItem(t);return e?JSON.parse(e):h}get storageType(){return"session"}loadPersistedStateCallback(t){return this.getAction("USER_VEHICLE_LOAD_PERSISTED_STATE",t)}async transformToPersistentState(t){return t}getReducer(){return(t=h,e)=>e.type===this.getActionType(S)?{...t,...e.payload}:t}getPublicDispatchers(){return{updateUserVehicle:t=>this.getAction(S,t)}}}const E="CAMPAIGN_CONTEXT_CONNECTION",m="CAMPAIGN_CONTEXT_LOAD_PERSISTED_STATE",T={},g=["utm_source","utm_medium","utm_campaign","utm_term","utm_content","gclid","dclid","gagcmid"];class CampaignContextConnection extends OneContextPersistentStore{allowedTenants=[r];constructor(){super(E)}async onBeforeRegister(e){t("ConsentContextConnection",{tenant:r,componentName:E,callback:async t=>{if(t.find((t=>"Context_Data"===t.name&&t.enabled))){const t=await this.loadPersistedStateCallback(this.getState());e(t),await this.storeState(this.getState())}}})}getState(){if(!a())return{};const t=new URLSearchParams(window.location.search);if(e=t,g.filter((t=>e.has(t))).length>0)return(t=>{const e={};return g.forEach((n=>{t.has(n)&&(e[n]=t.get(n)?.replace(" ","+"))})),e})(t);var e;const n=`swsp:${this.name}`,s=sessionStorage.getItem(n);return s?JSON.parse(s):{}}get initialState(){return T}get storageType(){return"session"}loadPersistedStateCallback(t){return this.getAction(m,t)}async transformToPersistentState(t){return t}getReducer(){return(t,e)=>{if(e.type===this.getActionType(m))return{...e.payload}}}getPublicDispatchers(){return{}}}var O;!function(t){t.START_GUIDED_SESSION="startGuidedSession",t.UPDATE_GUIDED_SESSION="updateGuidedSession",t.END_GUIDED_SESSION="endGuidedSession",t.ADD_EVENT="addEvent"}(O||(O={}));var p;!function(t){t.WL_VEHICLE_ADDED="WL_VEHICLE_ADDED",t.WL_VEHICLE_UPDATED="WL_VEHICLE_UPDATED",t.WL_VEHICLE_REMOVED="WL_VEHICLE_REMOVED"}(p||(p={}));const f={isOnBehalfEnabled:!1};class SalesExpertConnection extends OneContextPersistentStore{allowedTenants=["sem","eqpodc"];allowedGuidedSessionEventTypes={sem:Object.values(p),eqpodc:Object.values(p).filter((t=>t.startsWith("WL_")))};constructor(){super("SALES_EXPERT_CONNECTION")}async onBeforeRegister(t){const e=await this.loadPersistedStateCallback(this.initialState);null!=e&&t(e),await this.storeState(this.initialState)}get initialState(){const t=`swsp:${this.name}`,e=!!a()&&localStorage.getItem(t);return e?JSON.parse(e):f}get storageType(){return"local"}loadPersistedStateCallback(t){return this.getAction("SALES_EXPERT_LOAD_PERSISTED_STATE",t)}async transformToPersistentState(t){return t}mutateStateIfAllowed(t,e,n,s){return s.includes(n)?e:t}guidedSessionStateFactory(t){return{startTimestamp:(new Date).toISOString(),events:[],...t}}guidedSessionEventFactory(t,e){return{tenant:e,timestamp:(new Date).toISOString(),...t}}getReducer(){return(t=f,e)=>{if(e.type===this.getActionType(O.START_GUIDED_SESSION)){const{guidedSession:n,tenant:s}=e.payload,o=this.guidedSessionStateFactory(n),i={...t,guidedSession:o,isOnBehalfEnabled:!0};return this.mutateStateIfAllowed(t,i,s,["sem"])}if(e.type===this.getActionType(O.UPDATE_GUIDED_SESSION)){const{guidedSession:n,tenant:s}=e.payload,o={...t,guidedSession:{...t.guidedSession,...n}};return this.mutateStateIfAllowed(t,o,s,["sem"])}if(e.type===this.getActionType(O.END_GUIDED_SESSION)){const{tenant:n}=e.payload,s={...t,guidedSession:void 0,isOnBehalfEnabled:!1};return this.mutateStateIfAllowed(t,s,n,["sem"])}if(e.type===this.getActionType(O.ADD_EVENT)){const{event:n,tenant:s}=e.payload,o=this.guidedSessionEventFactory(n,s);if(!t.guidedSession)return t;const i={...t,guidedSession:{...t.guidedSession,events:[...t.guidedSession.events,o]}};return this.mutateStateIfAllowed(t,i,n.type,this.allowedGuidedSessionEventTypes[s]??[])}return t}}getPublicDispatchers(){return{startGuidedSession:t=>this.getAction(O.START_GUIDED_SESSION,t),updateGuidedSession:t=>this.getAction(O.UPDATE_GUIDED_SESSION,t),endGuidedSession:t=>this.getAction(O.END_GUIDED_SESSION,t),addEvent:t=>this.getAction(O.ADD_EVENT,t)}}}const P="UPDATE_CONSENT_CONTEXT",_=[];class ConsentContextConnection extends OneContextStore{allowedTenants=["seamless"];constructor(){super("CONSENT_CONTEXT_CONNECTION"),a()&&this.addEventListeners()}get initialState(){return _}getReducer(){return(t=_,e)=>e.type===this.getActionType(P)?e.payload:t}addEventListeners(){window.addEventListener("usercentrics-consents-updated",this.consentListener,!1),document.addEventListener("usercentrics-consents-loaded",this.consentListener,!1)}consentListener=async t=>{t.detail?.consents&&import("@seamless/one-context").then((async e=>{await e.getDispatchers(r,"ConsentContextConnection").then((e=>{e?.updateConsentContext(t.detail.consents,"seamless")}))}))};getPublicDispatchers(){return{updateConsentContext:t=>this.getAction(P,t)}}}var w;!function(t){t.B2C_DEFAULT="B2C_DEFAULT",t.B2B_DEFAULT="B2B_DEFAULT"}(w||(w={}));const N={};class ProfileConnection extends OneContextPersistentStore{allowedTenants=["iam","mhb2b","pal"];get storageType(){return"session"}get namespaceKey(){return`swsp:${this.name}`}get initialState(){const t=!!a()&&sessionStorage.getItem(this.namespaceKey);return t?JSON.parse(t):N}getReducer(){return(t,e)=>{switch(e.type){case this.getActionType("setProfileState"):{const n=e.payload;return{...t,...n}}case this.getActionType("setActiveProfile"):{const n=e.payload,s=this.defineActiveProfile(n,t.availableProfiles);return{...t,activeProfile:s}}default:return t}}}constructor(){super("PROFILE_CONNECTION")}async onBeforeRegister(t){const e=!!a()&&sessionStorage.getItem(this.namespaceKey);if(e){const n=JSON.parse(e),s=await this.loadPersistedStateCallback(n);null!=s&&t(s)}}async onStateChange(t){return await this.persistProfileState(this.namespaceKey,this.transformToPersistentState(t)),Promise.resolve()}loadPersistedStateCallback(t){return this.getAction("PROFILE_PERSISTED_STATE",t)}transformToPersistentState(t){return t}defineActiveProfile(t,e){const n=e.at(0);if(!n.id)return n;if(t){const n=e.find((e=>e.id===t||e.meId===t));if(n)return n}const s=e.find((t=>"B2B"===t.businessType));return s||n}async persistProfileState(t,e){if(a())try{const n=window.localStorage.getItem(t),s=window.sessionStorage.getItem(t),o=JSON.parse(n||"{}").profileId||null,{id:i,businessType:r}=e.activeProfile||{},a={businessType:r,profileId:"B2B"===r&&i!==w.B2B_DEFAULT?i:o};if(window.localStorage.setItem(t,JSON.stringify(a)),window.sessionStorage.setItem(t,JSON.stringify(e)),JSON.stringify(e)!==s){console.info("Sending new state to other tabs");new BroadcastChannel("B2X_CUSTOMER_BROADCAST_CHANNEL").postMessage({key:t,value:e})}}catch(t){console.error("Profile Connection PersistProfileState error:",t)}}getPublicDispatchers(){return{setProfileState:t=>this.getAction("setProfileState",t),setActiveProfile:t=>this.getAction("setActiveProfile",t)}}}(async()=>{e({name:"ConsentContextConnection",connectionMethod:ConsentContextConnection,tenant:"seamless"}),e({name:"PageConnection",connectionMethod:PageEnvironmentConnection,tenant:"mbmxp"}),e({name:"MBScoreConnection",connectionMethod:MBScoreConnection,tenant:"cuan"}),e({name:"ProfileConnection",connectionMethod:ProfileConnection,tenant:"iam"}),e({name:"DealerContextConnection",connectionMethod:DealerContextConnection,tenant:"seamless"}),e({name:"BrandContextConnection",connectionMethod:BrandContextConnection,tenant:"seamless"}),e({name:"UserVehicleConnection",connectionMethod:UserVehicleConnection,tenant:"mmv"}),e({name:"CampaignContextConnection",connectionMethod:CampaignContextConnection,tenant:"seamless"}),e({name:"SalesExpertConnection",connectionMethod:SalesExpertConnection,tenant:"sem"})})();
//# sourceMappingURL=index.js.map
